---
kind: pipeline
type: docker
name: mssql_test

clone:
  disable: true

volumes:
- name: data
  temp: {}

services:
- name: db_mssql
  image: mcr.microsoft.com/mssql/server:2017-latest
  volumes:
  - name: data
    path: /home/data
  environment:
    ACCEPT_EULA: Y
    SA_PASSWORD: Aa123456

steps:
- name: api_test
  image: chg80333/goadmin-test:v4
  volumes:
  - name: data
    path: /go/src/github.com/GoAdminGroup/go-admin/tests/data
  environment:
    GO111MODULE: on
    GOPROXY: https://goproxy.cn
  commands:
  - cd /go/src/github.com/GoAdminGroup/go-admin
  - git pull
  - while (($? == 1)); do sleep 2;git pull; done
  - git checkout -- go.mod go.sum
  - git checkout $DRONE_COMMIT
  - sleep 80
  - make ms-test

---
kind: pipeline
type: docker
name: postgresql_test

clone:
  disable: true

services:
- name: db_pgsql
  image: postgres:10
  environment:
    POSTGRES_USER: postgres
    POSTGRES_DB: go-admin-test
    POSTGRES_PASSWORD: root 

steps:  
- name: api_test
  image: chg80333/goadmin-test:v4
  environment:
    GO111MODULE: on
    GOPROXY: https://goproxy.cn
  commands:
  - cd /go/src/github.com/GoAdminGroup/go-admin
  - git pull
  - while (($? == 1)); do sleep 2;git pull; done
  - git checkout -- go.mod go.sum
  - git checkout $DRONE_COMMIT
  - sleep 80
  - make pg-test

---
kind: pipeline
type: docker
name: sqlite_test

clone:
  disable: true

steps:  
- name: api_test
  image: chg80333/goadmin-test:v4
  environment:
    GO111MODULE: on
    GOPROXY: https://goproxy.cn
  commands:
  - cd /go/src/github.com/GoAdminGroup/go-admin
  - git pull
  - while (($? == 1)); do sleep 2;git pull; done
  - git checkout -- go.mod go.sum
  - git checkout $DRONE_COMMIT
  - sleep 80
  - make sqlite-test

---
kind: pipeline
type: docker
name: mysql_test

clone:
  disable: true

services:
- name: db_mysql
  image: mysql:5.7
  environment:
    MYSQL_ROOT_PASSWORD: root
    MYSQL_DATABASE: go-admin-test

steps:  
- name: api_test
  image: chg80333/goadmin-test:v4
  environment:
    GO111MODULE: on
    GOPROXY: https://goproxy.cn
  commands:
  - cd /go/src/github.com/GoAdminGroup/go-admin
  - git pull
  - while (($? == 1)); do sleep 2;git pull; done
  - git checkout -- go.mod go.sum
  - git checkout $DRONE_COMMIT
  - sleep 80
  - make mysql-test