# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
orbs:
  browser-tools: circleci/browser-tools@1.1.3
jobs:
  build:
    working_directory: /go/src/github.com/GoAdminGroup/go-admin
    docker:
      - image: circleci/golang:1.15.8
      - image: circleci/mysql:5.7
        environment:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: go-admin-test
      - image: circleci/postgres:9.6-alpine        
        environment: # environment variables for primary container
          POSTGRES_USER: postgres
          POSTGRES_DB: go-admin-test
    steps:
      - browser-tools/install-chrome
      - browser-tools/install-chromedriver
      - run:
          command: |
            google-chrome --version
            chromedriver --version
            google-chrome --headless --disable-gpu --remote-debugging-port=9222 http://localhost &
          name: Check chrome tools and start
      - checkout
      - restore_cache:
          keys:
            - go-mod-v4-{{ checksum "go.sum" }}
      - run:
          name: Install Dependencies
          command: |
            go mod download
            go get -u github.com/rakyll/gotest
            go get -u -v github.com/gogf/gf@v1.12.1
            sudo chmod -R 777 $GOPATH/pkg/mod/github.com/gogf/gf@v1.12.1/net/ghttp/ghttp_server_handler.go
            sudo echo -e "\nfunc (s *Server) DefaultHttpHandle(w http.ResponseWriter, r *http.Request) { \n s.handleRequest(w, r) \n}\n" >> $GOPATH/pkg/mod/github.com/gogf/gf@v1.12.1/net/ghttp/ghttp_server_handler.go
            go get github.com/GoAdminGroup/themes@master
      - save_cache:
          key: go-mod-v4-{{ checksum "go.sum" }}
          paths:
            - "/go/pkg/mod"          
      - run:
          name: Setup database
          command: |
            dockerize -wait tcp://127.0.0.1:3306 -timeout 1m
            sudo apt-get install default-mysql-client            
            dockerize -wait tcp://localhost:5432 -timeout 1m
            sudo apt install -y postgresql-client
      - setup_remote_docker:
          version: 19.03.13
      - run:
          name: Build mssql environment
          command: |
            docker run -e "ACCEPT_EULA=Y" -e "SA_PASSWORD=Aa123456" -v /go/src/github.com/GoAdminGroup/go-admin/tests/data:/home/data -p 1433:1433 --name mssql -d mcr.microsoft.com/mssql/server:2017-latest
            docker cp /go/src/github.com/GoAdminGroup/go-admin/tests/data/admin_ms.bak mssql:/home/data/
      - run:
          name: Run tests
          command: make test
